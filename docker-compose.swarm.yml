version: '3.8'

networks:
  network_public:
    external: true

services:
  app:
    image: ghcr.io/hectorcanaimero/menu-maestro-saas:latest

    networks:
      - network_public

    deploy:
      mode: replicated
      replicas: 3

      placement:
        preferences:
          - spread: node.id

      update_config:
        parallelism: 1
        delay: 15s
        failure_action: rollback
        monitor: 30s
        max_failure_ratio: 0.3
        order: start-first

      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: pause
        monitor: 30s
        order: start-first

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

      labels:
        # ====================================================================
        # TRAEFIK CONFIGURATION
        # ====================================================================
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"

        # Service configuration (CRITICAL - define el puerto del container)
        - "traefik.http.services.pideai.loadbalancer.server.port=80"

        # ====================================================================
        # HTTP Router (Port 80) - Redirect to HTTPS
        # ====================================================================
        - "traefik.http.routers.pideai-http.rule=Host(`artex.lat`) || Host(`www.artex.lat`) || HostRegexp(`{subdomain:[a-z0-9-]+}.artex.lat`)"
        - "traefik.http.routers.pideai-http.entrypoints=web"
        - "traefik.http.routers.pideai-http.middlewares=redirect-to-https"

        # ====================================================================
        # HTTPS Router (Port 443) - Main Router with Wildcard SSL
        # ====================================================================
        - "traefik.http.routers.pideai-https.rule=Host(`artex.lat`) || Host(`www.artex.lat`) || HostRegexp(`{subdomain:[a-z0-9-]+}.artex.lat`)"
        - "traefik.http.routers.pideai-https.entrypoints=websecure"
        - "traefik.http.routers.pideai-https.tls=true"
        - "traefik.http.routers.pideai-https.tls.certresolver=cloudflare"
        - "traefik.http.routers.pideai-https.middlewares=security-headers,compression"

        # Wildcard SSL Certificate (DNS-01 Challenge via Cloudflare)
        - "traefik.http.routers.pideai-https.tls.domains[0].main=artex.lat"
        - "traefik.http.routers.pideai-https.tls.domains[0].sans=*.artex.lat"

        # ====================================================================
        # MIDDLEWARES
        # ====================================================================

        # Redirect HTTP -> HTTPS
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

        # Security Headers
        - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
        - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
        - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
        - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
        - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
        - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
        - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
        - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
        - "traefik.http.middlewares.security-headers.headers.permissionsPolicy=camera=(), microphone=(), geolocation=(), payment=()"

        # Content Security Policy (con soporte completo para PostHog)
        - "traefik.http.middlewares.security-headers.headers.contentSecurityPolicy=default-src 'self' https:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://us.i.posthog.com https://us-assets.i.posthog.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https: blob:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self' https://*.supabase.co https://us.i.posthog.com https://us-assets.i.posthog.com wss://*.supabase.co; worker-src 'self' blob:; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"

        # Compression
        - "traefik.http.middlewares.compression.compress=true"

        # ====================================================================
        # LOAD BALANCER HEALTH CHECKS
        # ====================================================================
        - "traefik.http.services.pideai.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.pideai.loadbalancer.healthcheck.interval=30s"
        - "traefik.http.services.pideai.loadbalancer.healthcheck.timeout=5s"

        # ====================================================================
        # STICKY SESSIONS (Optional - descomenta si lo necesitas)
        # ====================================================================
        # - "traefik.http.services.pideai.loadbalancer.sticky.cookie=true"
        # - "traefik.http.services.pideai.loadbalancer.sticky.cookie.name=pideai_server"
        # - "traefik.http.services.pideai.loadbalancer.sticky.cookie.httpOnly=true"
        # - "traefik.http.services.pideai.loadbalancer.sticky.cookie.secure=true"

        # ====================================================================
        # RATE LIMITING (Optional - descomenta para protecci√≥n DDoS)
        # ====================================================================
        # - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
        # - "traefik.http.middlewares.rate-limit.ratelimit.period=1s"
        # - "traefik.http.middlewares.rate-limit.ratelimit.burst=200"

    environment:
      - NODE_ENV=production
      - TZ=America/Caracas

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=pideai,environment=production"
